<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.Pawfect.mapper.BoardMapper">
	<select id="getPost" parameterType="int" resultType="com.example.Pawfect.dto.PostDto">
        SELECT
	        p.*,
	        u.userNickname,
	        (SELECT COUNT(*) FROM post_likes pl WHERE pl.postID = p.postId) AS likeCount,
	        (SELECT COUNT(*) FROM comment c WHERE c.postID = p.postId) AS commentCount
	    FROM post p
	    JOIN user u ON p.userId = u.userId
	    WHERE p.postId = #{postId}
    </select>
    
    <select id="getPosts" resultType="com.example.Pawfect.dto.PostDto" parameterType="map">
	    SELECT 
	        p.*, 
	        u.userNickname,
	        (SELECT COUNT(*) FROM post_likes pl WHERE pl.postId = p.postId) AS likeCount,
	        (SELECT COUNT(*) FROM comment c WHERE c.postId = p.postId) AS commentCount
	    FROM post p
	    JOIN user u ON p.userId = u.userId
	    WHERE 1 = 1
	    <if test="keyword != null and keyword != ''">
	        AND p.postTitle LIKE CONCAT('%', #{keyword}, '%')
	    </if>
	    <if test="postType != null and postType != '' and postType != 0">
	        AND p.postType = #{postType}
	    </if>
	    <if test="startDate != null and endDate != null">
	        AND p.postRegdate BETWEEN #{startDate} AND DATE_ADD(#{endDate}, INTERVAL 1 DAY)
	    </if>
	    ORDER BY 
	        <choose>
	            <when test="sortBy == 'views'">p.postViewCount DESC</when>
	            <when test="sortBy == 'likes'">
	                (SELECT COUNT(*) FROM post_likes WHERE postId = p.postId) DESC
	            </when>
	            <when test="sortBy == 'comments'">
	                (SELECT COUNT(*) FROM comment WHERE postId = p.postId) DESC
	            </when>
	            <otherwise>p.postRegdate DESC</otherwise>
	        </choose>
	    LIMIT #{start}, #{pageSize}
	</select>
    
    <select id="getPostCount" resultType="int" parameterType="map">
        SELECT COUNT(*) FROM post
        WHERE 1 = 1
        <if test="keyword != null and keyword != ''">
            AND postTitle LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="postType != null and postType != 0">
            AND postType = #{postType}
        </if>
        <if test="startDate != null and endDate != null">
            AND postRegdate BETWEEN #{startDate} AND DATE_ADD(#{endDate}, INTERVAL 1 DAY)
        </if>
    </select>

    <insert id="insertPost" parameterType="com.example.Pawfect.dto.PostDto" useGeneratedKeys="true" keyProperty="postId">
	  INSERT INTO post (userId, postType, postTitle, postContent)
	  VALUES (#{userId}, #{postType}, #{postTitle}, #{postContent})
	</insert>
	
	<update id="modifyPost" parameterType="com.example.Pawfect.dto.PostDto">
	  UPDATE post
	  SET postTitle = #{postTitle},
	      postContent = #{postContent},
	      postType = #{postType}
	  WHERE postId = #{postId}
	</update>

	<delete id="deletePost" parameterType="int">
	  DELETE FROM post WHERE postId = #{postId}
	</delete>
	
	<update id="incrementViewCount" parameterType="int">
	  UPDATE post SET postViewCount = postViewCount + 1 WHERE postId = #{postId}
	</update>
	
	<select id="getTotalLikeCount" resultType="int" parameterType="int">
		SELECT COUNT(*) FROM post_likes WHERE postId=#{postId}
	</select>
    
    
    <!-- FOR SIDEBAR STATS-->
    <select id="getTotalPostCount" resultType="int">
        SELECT COUNT(*) FROM post
    </select>

    <select id="getTotalCommentCount" resultType="int">
        SELECT COUNT(*) FROM comment
    </select>

    <select id="getTotalUserCount" resultType="int">
        SELECT COUNT(*) FROM user
    </select>

	
</mapper>
